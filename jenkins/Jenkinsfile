parameters {
    choice(
        name: 'ACTION',
        choices: ['apply', 'destroy'],
        description: 'Apply infrastructure or destroy it'
    )
}

pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        GITHUB_REPO = 'https://github.com/rahulbonkur/devops-infrastructure-project.git'
    }

    stages {

        stage('Clone Repository') {
            steps {
                echo '=== Cloning GitHub Repository ==='
                sh 'rm -rf /var/lib/jenkins/workspace/devops-project'
                sh "git clone ${GITHUB_REPO} /var/lib/jenkins/workspace/devops-project"
            }
        }

        stage('Terraform Init') {
            steps {
                echo '=== Initializing Terraform ==='
                dir('/var/lib/jenkins/workspace/devops-project/terraform') {
                    sh 'terraform init -upgrade'
                }
            }
        }

        stage('Terraform Apply / Destroy') {
            steps {
                script {
                    dir('/var/lib/jenkins/workspace/devops-project/terraform') {
                        if (params.ACTION == 'destroy') {
                            echo 'üî• Destroying AWS Infrastructure'
                            sh 'terraform destroy -auto-approve'
                        } else {
                            echo 'üöÄ Applying AWS Infrastructure'
                            sh 'terraform apply -auto-approve'
                        }
                    }
                }
            }
        }

        stage('Wait for Instances') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                echo '=== Waiting for instances ==='
                sleep(time: 90, unit: 'SECONDS')
            }
        }

        stage('Get IPs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    dir('/var/lib/jenkins/workspace/devops-project/terraform') {
                        env.DOCKER_IP = sh(
                            script: 'terraform output -raw docker_host_public_ip',
                            returnStdout: true
                        ).trim()

                        env.PYTHON_IP = sh(
                            script: 'terraform output -raw ansible_slave_public_ip',
                            returnStdout: true
                        ).trim()

                        echo "Docker Host: ${env.DOCKER_IP}"
                        echo "Python Host: ${env.PYTHON_IP}"
                    }
                }
            }
        }

        stage('Create Inventory') {
    when {
        expression { params.ACTION == 'apply' }
    }
    steps {
        script {
            dir('/var/lib/jenkins/workspace/devops-project/ansible') {
                sh '''
                  echo "### GENERATING INVENTORY ###"
                  sed "s/DOCKER_HOST_IP/${env.DOCKER_IP}/g" inventory_template.ini > inventory.ini
                  sed -i "s/ANSIBLE_SLAVE_IP/${env.PYTHON_IP}/g" inventory.ini
                  echo "### FINAL INVENTORY ###"
                  cat inventory.ini
                '''
            }
        }
    }
}
        stage('Deploy Docker App') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir('/var/lib/jenkins/workspace/devops-project/ansible') {
                    sh 'ansible-playbook -i inventory.ini deploy_docker_app.yml --private-key ~/.ssh/ansible-class.pem'
                }
            }
        }

        stage('Deploy Python App') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir('/var/lib/jenkins/workspace/devops-project/ansible') {
                    sh 'ansible-playbook -i inventory.ini deploy_python_app.yml --private-key ~/.ssh/ansible-class.pem'
                }
            }
        }

        stage('Display URLs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                echo """
==================================================
‚úÖ DEPLOYMENT SUCCESSFUL!
==================================================
üé® Portfolio: http://${env.DOCKER_IP}
üçõ Recipe App: http://${env.PYTHON_IP}:5000
==================================================
"""
            }
        }
    }
}
