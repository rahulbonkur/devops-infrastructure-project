pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['apply', 'destroy'],
            description: 'Apply or Destroy Infrastructure'
        )
    }

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        GITHUB_REPO = 'https://github.com/rahulbonkur/devops-infrastructure-project.git'
        PROJECT_DIR = '/var/lib/jenkins/workspace/devops-project'
        SSH_KEY = '/var/lib/jenkins/.ssh/ansible-class.pem'
    }

    stages {

        stage('Verify AWS Credentials') {
            steps {
                echo '=== Verifying AWS Credentials ==='
                sh 'aws sts get-caller-identity'
            }
        }

        stage('Clean Workspace') {
            steps {
                echo '=== Cleaning old workspace ==='
                sh "rm -rf ${PROJECT_DIR}"
            }
        }

        stage('Clone Repository') {
            steps {
                sh "git clone ${GITHUB_REPO} ${PROJECT_DIR}"
            }
        }

        stage('Terraform Init') {
            steps {
                dir("${PROJECT_DIR}/terraform") {
                    sh 'terraform init -upgrade'
                }
            }
        }

        stage('Terraform Apply / Destroy') {
            steps {
                dir("${PROJECT_DIR}/terraform") {
                    script {
                        if (params.ACTION == 'destroy') {
                            echo 'DESTROYING INFRASTRUCTURE'
                            sh 'terraform destroy -auto-approve'
                        } else {
                            echo 'APPLYING INFRASTRUCTURE'
                            sh 'terraform apply -auto-approve'
                        }
                    }
                }
            }
        }

        stage('Stop After Destroy') {
            when {
                expression { params.ACTION == 'destroy' }
            }
            steps {
                echo 'Infrastructure destroyed successfully. Stopping pipeline.'
            }
        }

        stage('Wait for EC2 Instances') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                sleep(time: 60, unit: 'SECONDS')
            }
        }

        stage('Fetch EC2 IPs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${PROJECT_DIR}/terraform") {
                    script {
                        env.DOCKER_IP = sh(
                            script: 'terraform output -raw docker_host_public_ip',
                            returnStdout: true
                        ).trim()

                        env.PYTHON_IP = sh(
                            script: 'terraform output -raw ansible_slave_public_ip',
                            returnStdout: true
                        ).trim()
                    }
                }
            }
        }

        stage('Generate Ansible Inventory') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${PROJECT_DIR}/ansible") {
                    sh """
                        rm -f inventory.ini
                        sed 's/DOCKER_HOST_IP/${env.DOCKER_IP}/g' inventory_template.ini > inventory.ini
                        sed -i 's/ANSIBLE_SLAVE_IP/${env.PYTHON_IP}/g' inventory.ini
                        cat inventory.ini
                    """
                }
            }
        }

        stage('Verify Ansible Connectivity') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${PROJECT_DIR}/ansible") {
                    sh "ansible all -i inventory.ini -m ping --private-key ${SSH_KEY}"
                }
            }
        }

        stage('Deploy Portfolio (Docker Host)') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${PROJECT_DIR}/ansible") {
                    sh "ansible-playbook -i inventory.ini deploy_docker_app.yml --private-key ${SSH_KEY}"
                }
            }
        }

        stage('Deploy Recipe App (Python Host)') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${PROJECT_DIR}/ansible") {
                    sh "ansible-playbook -i inventory.ini deploy_python_app.yml --private-key ${SSH_KEY}"
                }
            }
        }

        stage('Verify Applications') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                sh """
                    curl -I http://${env.DOCKER_IP} || true
                    curl -I http://${env.PYTHON_IP}:5000 || true
                """
            }
        }

        stage('Display URLs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                echo """
DEPLOYMENT SUCCESSFUL

Portfolio:
http://${env.DOCKER_IP}

Recipe App:
http://${env.PYTHON_IP}:5000
"""
            }
        }
    }

    post {
        success {
            echo "PIPELINE SUCCESS: ${params.ACTION.toUpperCase()}"
        }
        failure {
            echo 'PIPELINE FAILED'
        }
        always {
            echo "Pipeline finished at: ${new Date()}"
        }
    }
}
