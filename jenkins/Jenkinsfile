pipeline {
    agent any
    
    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        GITHUB_REPO = 'https://github.com/rahulbonkur/devops-infrastructure-project.git'
    }
    
    stages {
        stage('Verify AWS Credentials') {
            steps {
                script {
                    echo '=== Verifying AWS Credentials ==='
                    sh 'aws sts get-caller-identity'
                }
            }
        }
        
        stage('Clone Repository') {
            steps {
                script {
                    echo '=== Cloning GitHub Repository ==='
                    sh 'rm -rf /var/lib/jenkins/workspace/devops-project'
                    sh 'git clone ${GITHUB_REPO} /var/lib/jenkins/workspace/devops-project'
                }
            }
        }
        
        stage('Terraform Init') {
            steps {
                script {
                    echo '=== Initializing Terraform ==='
                    dir('/var/lib/jenkins/workspace/devops-project/terraform') {
                        sh 'terraform init -upgrade'
                    }
                }
            }
        }
        
        stage('Terraform Apply') {
            steps {
                script {
                    echo '=== Creating AWS Infrastructure ==='
                    dir('/var/lib/jenkins/workspace/devops-project/terraform') {
                        sh 'terraform apply -auto-approve'
                    }
                }
            }
        }
        
        stage('Get Instance IPs') {
            steps {
                script {
                    echo '=== Retrieving EC2 Instance IPs ==='
                    dir('/var/lib/jenkins/workspace/devops-project/terraform') {
                        env.DOCKER_IP = sh(
                            script: 'terraform output -raw docker_host_public_ip',
                            returnStdout: true
                        ).trim()
                        env.PYTHON_IP = sh(
                            script: 'terraform output -raw ansible_slave_public_ip',
                            returnStdout: true
                        ).trim()
                        
                        echo "ğŸ³ Docker Host IP: ${env.DOCKER_IP}"
                        echo "ğŸ Python Host IP: ${env.PYTHON_IP}"
                    }
                }
            }
        }
        
        stage('Wait for Instances') {
            steps {
                script {
                    echo '=== Waiting for EC2 instances to initialize ==='
                    sleep(time: 90, unit: 'SECONDS')
                }
            }
        }
        
        stage('Create Ansible Inventory') {
            steps {
                script {
                    echo '=== Creating Ansible Inventory ==='
                    dir('/var/lib/jenkins/workspace/devops-project/ansible') {
                        sh """
                            sed 's/DOCKER_HOST_IP/${env.DOCKER_IP}/g' inventory_template.ini > inventory.ini
                            sed -i 's/ANSIBLE_SLAVE_IP/${env.PYTHON_IP}/g' inventory.ini
                            echo "Generated Inventory:"
                            cat inventory.ini
                        """
                    }
                }
            }
        }
        
        stage('Test SSH Connectivity') {
            steps {
                script {
                    echo '=== Testing SSH Connectivity ==='
                    retry(5) {
                        sh """
                            echo "Testing Docker Host..."
                            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /var/lib/jenkins/.ssh/devops-key.pem ec2-user@${env.DOCKER_IP} 'echo "âœ… Docker host connected"'
                            
                            echo "Testing Python Host..."
                            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /var/lib/jenkins/.ssh/devops-key.pem ec2-user@${env.PYTHON_IP} 'echo "âœ… Python host connected"'
                        """
                        sleep(time: 10, unit: 'SECONDS')
                    }
                }
            }
        }
        
        stage('Verify Ansible Connectivity') {
            steps {
                script {
                    echo '=== Verifying Ansible Can Reach All Hosts ==='
                    dir('/var/lib/jenkins/workspace/devops-project/ansible') {
                        retry(3) {
                            sh 'ansible all -i inventory.ini -m ping'
                        }
                    }
                }
            }
        }
        
        stage('Deploy Portfolio Website') {
            steps {
                script {
                    echo '=== Deploying UI/UX Portfolio Website ==='
                    dir('/var/lib/jenkins/workspace/devops-project/ansible') {
                        sh 'ansible-playbook -i inventory.ini deploy_docker_app.yml -v'
                    }
                }
            }
        }
        
        stage('Deploy Recipe App') {
            steps {
                script {
                    echo '=== Deploying Food Recipe Application ==='
                    dir('/var/lib/jenkins/workspace/devops-project/ansible') {
                        sh 'ansible-playbook -i inventory.ini deploy_python_app.yml -v'
                    }
                }
            }
        }
        
        stage('Verify Deployments') {
            steps {
                script {
                    echo '=== Verifying Both Applications ==='
                    
                    sh """
                        echo "Testing Portfolio Website..."
                        curl -s -o /dev/null -w "HTTP Status: %{http_code}\\n" http://${env.DOCKER_IP}/ || echo "âŒ Portfolio check failed"
                    """
                    
                    sh """
                        echo "Testing Recipe App..."
                        curl -s -o /dev/null -w "HTTP Status: %{http_code}\\n" http://${env.PYTHON_IP}:5000/ || echo "âŒ Recipe app check failed"
                    """
                }
            }
        }
        
        stage('Display URLs') {
            steps {
                script {
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                          â•‘
â•‘            âœ…  DEPLOYMENT SUCCESSFUL!                    â•‘
â•‘                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¨ UI/UX PORTFOLIO WEBSITE:
   ğŸ‘‰ http://${env.DOCKER_IP}

ğŸ› INDIAN FOOD RECIPE APP:
   ğŸ‘‰ http://${env.PYTHON_IP}:5000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    INFRASTRUCTURE DETAILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    dir('/var/lib/jenkins/workspace/devops-project/terraform') {
                        sh 'terraform output'
                    }
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ‰ PIPELINE COMPLETED SUCCESSFULLY!                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“± Access your applications:
   ğŸ¨ Portfolio: http://${env.DOCKER_IP}
   ğŸ› Recipes: http://${env.PYTHON_IP}:5000

ğŸ—ï¸  Infrastructure created with:
   âœ“ Terraform (AWS VPC, EC2, Security Groups)
   âœ“ Docker (Containerized portfolio website)
   âœ“ Ansible (Configuration management)
   âœ“ Jenkins (CI/CD automation)
                """
            }
        }
        failure {
            script {
                echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      âŒ PIPELINE FAILED                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Common issues to check:
  - AWS credentials configured correctly
  - SSH key exists at /var/lib/jenkins/.ssh/devops-key.pem
  - GitHub repository URL correct
  - Security groups allow ports 22, 80, 5000
  - EC2 instances are running

Check the console output above for specific errors.
                """
            }
        }
        always {
            script {
                echo "Pipeline execution completed at: ${new Date()}"
            }
        }
    }
}
