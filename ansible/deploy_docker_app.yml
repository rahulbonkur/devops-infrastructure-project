- name: Deploy Dockerized UI/UX Portfolio Website
  hosts: docker_host
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
  tasks:
    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: Install pip3
      yum:
        name: python3-pip
        state: present

    - name: Install Docker SDK for Python
      pip:
        name: docker
        executable: pip3
        state: present

    - name: Restart Docker service
      service:
        name: docker
        state: restarted

    - name: Wait for Docker socket
      wait_for:
        path: /var/run/docker.sock
        state: present
        timeout: 30

    - name: Stop existing container (using shell)
      shell: docker stop portfolio-website || true
      ignore_errors: yes

    - name: Remove existing container (using shell)
      shell: docker rm portfolio-website || true
      ignore_errors: yes

    - name: Remove existing image (using shell)
      shell: docker rmi portfolio-website || true
      ignore_errors: yes

    - name: Remove existing directory
      file:
        path: /home/ec2-user/devops-infrastructure-project
        state: absent

    - name: Clone repository
      git:
        repo: 'https://github.com/rahulbonkur/devops-infrastructure-project.git'
        dest: /home/ec2-user/devops-infrastructure-project
        force: yes

    - name: Build Docker image (using shell)
      shell: |
        cd /home/ec2-user/devops-infrastructure-project/portfolio-website
        docker build -t portfolio-website .
      register: build_output

    - name: Show build output
      debug:
        var: build_output.stdout_lines

    - name: Run Docker container (using shell)
      shell: |
        docker run -d \
          --name portfolio-website \
          --restart always \
          -p 80:80 \
          portfolio-website
      register: run_output

    - name: Show container ID
      debug:
        var: run_output.stdout

    - name: Verify container is running
      shell: docker ps --filter name=portfolio-website --format "{{.Status}}"
      register: container_status

    - name: Show container status
      debug:
        msg: "Container status: {{ container_status.stdout }}"

    - name: Test website locally
      shell: curl -s http://localhost | head -10
      register: curl_output
      ignore_errors: yes

    - name: Show website test
      debug:
        var: curl_output.stdout_lines
