- name: Deploy Dockerized UI/UX Portfolio Website
  hosts: docker_host
  become: yes
  tasks:
    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: Restart Docker to apply group changes
      service:
        name: docker
        state: restarted

    - name: Wait for Docker to be ready
      pause:
        seconds: 5

    - name: Stop existing container
      shell: docker stop portfolio-website 2>/dev/null || true
      ignore_errors: yes

    - name: Remove existing container
      shell: docker rm portfolio-website 2>/dev/null || true
      ignore_errors: yes

    - name: Remove existing image
      shell: docker rmi portfolio-website 2>/dev/null || true
      ignore_errors: yes

    - name: Remove existing project directory
      file:
        path: /home/ec2-user/devops-infrastructure-project
        state: absent

    - name: Clone GitHub repository
      git:
        repo: 'https://github.com/rahulbonkur/devops-infrastructure-project.git'
        dest: /home/ec2-user/devops-infrastructure-project
        force: yes

    - name: Build Docker image
      shell: |
        cd /home/ec2-user/devops-infrastructure-project/portfolio-website
        docker build -t portfolio-website .
      register: build_result

    - name: Display build output
      debug:
        msg: "{{ build_result.stdout_lines }}"

    - name: Run Docker container
      shell: |
        docker run -d \
          --name portfolio-website \
          --restart always \
          -p 80:80 \
          portfolio-website
      register: container_result

    - name: Display container ID
      debug:
        msg: "Container started with ID: {{ container_result.stdout }}"

    - name: Verify container is running
      shell: docker ps --filter name=portfolio-website --format "{{.Names}}\t{{.Status}}"
      register: verify_result

    - name: Display container status
      debug:
        msg: "{{ verify_result.stdout }}"

    - name: Test website locally
      uri:
        url: http://localhost
        return_content: no
        status_code: 200
      register: health_check
      retries: 3
      delay: 5
      until: health_check.status == 200

    - name: Display success message
      debug:
        msg: "âœ… Portfolio website deployed successfully on port 80"
