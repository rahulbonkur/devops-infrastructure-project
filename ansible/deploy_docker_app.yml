---
- name: Deploy Dockerized UI/UX Portfolio Website
  hosts: docker_host
  become: yes
  gather_facts: yes

  tasks:
    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: Restart Docker to apply group changes
      service:
        name: docker
        state: restarted

    - name: Wait for Docker to be ready
      pause:
        seconds: 5

    - name: Stop existing container (if any)
      docker_container:
        name: portfolio-website
        state: absent
      ignore_errors: yes

    - name: Remove existing image (if any)
      docker_image:
        name: portfolio-website
        state: absent
      ignore_errors: yes

    - name: Remove existing project directory
      file:
        path: /home/ec2-user/devops-infrastructure-project
        state: absent

    - name: Clone GitHub repository
      git:
        repo: 'https://github.com/rahulbonkur/devops-infrastructure-project.git'
        dest: /home/ec2-user/devops-infrastructure-project
        force: yes

    - name: Build Docker image
      docker_image:
        name: portfolio-website
        build:
          path: /home/ec2-user/devops-infrastructure-project/portfolio-website
        source: build
      register: build_result

    - name: Show Docker build result
      debug:
        msg: "Docker image built successfully"

    - name: Run Docker container
      docker_container:
        name: portfolio-website
        image: portfolio-website
        state: started
        restart_policy: always
        ports:
          - "80:80"
      register: container_result

    - name: Show container ID
      debug:
        msg: "Container started with ID: {{ container_result.container.Id }}"

    - name: Verify container is running
      docker_container_info:
        name: portfolio-website
      register: container_info

    - name: Show container status
      debug:
        msg: "Container status: {{ container_info.container.State.Status }}"

    - name: Test website locally
      uri:
        url: http://localhost
        status_code: 200
      register: health_check
      retries: 5
      delay: 5
      until: health_check.status == 200

    - name: Deployment success message
      debug:
        msg: "âœ… Portfolio website deployed successfully and accessible on port 80"
