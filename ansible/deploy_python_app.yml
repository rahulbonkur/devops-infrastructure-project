---
- name: Deploy Python Food Recipe App
  hosts: ansible_slave
  become: yes

  vars:
    app_root: /home/ec2-user/devops-infrastructure-project
    app_dir: /home/ec2-user/devops-infrastructure-project/recipe-app
    gunicorn_bin: /home/ec2-user/.local/bin/gunicorn
    gunicorn_log: /home/ec2-user/gunicorn.log

  tasks:

    - name: Install system dependencies
      dnf:
        name:
          - python3
          - python3-pip
        state: present

    - name: Install Flask and Gunicorn (user scope)
      pip:
        name:
          - flask
          - gunicorn
        executable: pip3
        extra_args: --user

    - name: Ensure gunicorn binary exists
      stat:
        path: "{{ gunicorn_bin }}"
      register: gunicorn_check

    - name: Fail if gunicorn not installed
      fail:
        msg: "âŒ Gunicorn binary not found at {{ gunicorn_bin }}"
      when: not gunicorn_check.stat.exists

    - name: Kill anything using port 5000
      shell: fuser -k 5000/tcp || true
      ignore_errors: yes

    - name: Stop old Gunicorn processes
      shell: pkill -f gunicorn || true
      ignore_errors: yes

    - name: Remove old project directory
      file:
        path: "{{ app_root }}"
        state: absent

    - name: Clone GitHub repository
      git:
        repo: 'https://github.com/rahulbonkur/devops-infrastructure-project.git'
        dest: "{{ app_root }}"
        force: yes

    - name: Verify recipe-app directory exists
      stat:
        path: "{{ app_dir }}"
      register: recipe_dir

    - name: Fail if recipe-app directory missing
      fail:
        msg: "âŒ recipe-app directory not found"
      when: not recipe_dir.stat.exists

    - name: Start Gunicorn (background, safe)
      shell: |
        cd {{ app_dir }}
        nohup {{ gunicorn_bin }} app:app \
          --bind 0.0.0.0:5000 \
          --workers 2 \
          > {{ gunicorn_log }} 2>&1 &
      args:
        executable: /bin/bash

    - name: Wait for port 5000 to open
      wait_for:
        host: 0.0.0.0
        port: 5000
        delay: 5
        timeout: 90

    - name: Check HTTP response (non-fatal)
      uri:
        url: http://localhost:5000
        return_content: no
        status_code: 200
      register: http_check
      failed_when: false

    - name: Show Gunicorn logs (ALWAYS)
      shell: tail -n 50 {{ gunicorn_log }}
      register: gunicorn_output
      changed_when: false

    - name: Final status
      debug:
        msg:
          - "âœ… Recipe App deployment finished"
          - "ğŸŒ URL: http://{{ ansible_host }}:5000"
          - "ğŸ“¡ HTTP status: {{ http_check.status | default('unknown') }}"
          - "ğŸ“„ Gunicorn log output:"
          - "{{ gunicorn_output.stdout }}"
